
from math import *
import random
import copy
import time

BOARD_FORMAT = "|-|---|1|------|2|------|3|------|4|------|5|------|6|------|7|------|8|------|9|---\n" \
               "|1| {0} | {1} | {2} | {3} | {4} | {5} | {6} | {7} | {8} |\n|" \
               "-|---------------------------------------------------------------------------------\n" \
               "|2| {9} | {10} | {11} | {12} | {13} | {14} | {15} | {16} | {17} |\n|" \
               "-|---------------------------------------------------------------------------------\n" \
               "|3| {18} | {19} | {20} | {21} | {22} | {23} | {24} | {25} | {26} |\n|" \
               "-|---------------------------------------------------------------------------------\n" \
               "|4| {27} | {28} | {29} | {30} | {31} | {32} | {33} | {34} | {35} |\n|" \
               "-|---------------------------------------------------------------------------------\n" \
               "|5| {36} | {37} | {38} | {39} | {40} | {41} | {42} | {43} | {44} |\n|" \
               "-|---------------------------------------------------------------------------------\n" \
               "|6| {45} | {46} | {47} | {48} | {49} | {50} | {51} | {52} | {53} |\n|" \
               "-|---------------------------------------------------------------------------------\n" \
               "|7| {54} | {55} | {56} | {57} | {58} | {59} | {60} | {61} | {62} |\n|" \
               "-|---------------------------------------------------------------------------------\n" \
               "|8| {63} | {64} | {65} | {66} | {67} | {68} | {69} | {70} | {71} |\n|" \
               "-|---------------------------------------------------------------------------------\n" \
               "|9| {72} | {73} | {74} | {75} | {76} | {77} | {78} | {79} | {80} |\n|" \
               "-|---------------------------------------------------------------------------------"
NAMES = [' ', 'X', 'O']

# # 수 계산에 사용할 조건인 승리(end) 조건을 담는 부분
# end=[]
#
# # 가로 직선
# for a in range(0,5,1):
#     for b in range(a,a+73,9):
#         end.append(tuple([b,b+1,b+2,b+3,b+4]))
# # print(len(end))
#
# # 세로 직선
# for c in range(0,45,1):
#     end.append(tuple([c,c+9,c+18,c+27,c+36]))
# # print(len(end))
#
# # 대각선 ↘
# for d in range(0,37,9):
#     for e in range(d,d+5,1):
#         end.append(tuple([e,e+10,e+20,e+30,e+40]))
# # print(len(end))
#
# # 대각선 ↙
# for i in range(4,41,9):
#     for j in range(i,i+5,1):
#         end.append(tuple([j,j+8,j+16,j+24,j+32]))

class TicTacToe:
    def __init__(self, state=None):
        if state is None:
            state = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        self.playerJustMoved = 2
        self.state = state

    def Clone(self):
        state = TicTacToe()
        state.state = self.state[:]
        state.playerJustMoved = self.playerJustMoved
        return state

    def DoMove(self, move):
        assert int(move) >= 0 and int(move) <= 80 and self.state[move] == 0
        self.playerJustMoved = 3 - self.playerJustMoved
        self.state[move] = self.playerJustMoved

    def GetMoves(self):
        if self.checkState() != 0:
            return []

        else:
            moves = []
            for i in range(81):
                if self.state[i] == 0:
                    moves.append(i)

            return moves

    def GetResult(self, playerjm):
        result = self.checkState()
        assert result != 0
        if result == -1:
            return 0.5

        elif result == playerjm:
            return 1.0
        else:
            return 0.0

    def checkState(self):
        for (x, y, z, p, q) in [(0, 1, 2, 3, 4), (9, 10, 11, 12, 13), (18, 19, 20, 21, 22), (27, 28, 29, 30, 31), (36, 37, 38, 39, 40), (45, 46, 47, 48, 49), (54, 55, 56, 57, 58), (63, 64, 65, 66, 67), (72, 73, 74, 75, 76), (1, 2, 3, 4, 5), (10, 11, 12, 13, 14), (19, 20, 21, 22, 23), (28, 29, 30, 31, 32), (37, 38, 39, 40, 41), (46, 47, 48, 49, 50), (55, 56, 57, 58, 59), (64, 65, 66, 67, 68), (73, 74, 75, 76, 77), (2, 3, 4, 5, 6), (11, 12, 13, 14, 15), (20, 21, 22, 23, 24), (29, 30, 31, 32, 33), (38, 39, 40, 41, 42), (47, 48, 49, 50, 51), (56, 57, 58, 59, 60), (65, 66, 67, 68, 69), (74, 75, 76, 77, 78), (3, 4, 5, 6, 7), (12, 13, 14, 15, 16), (21, 22, 23, 24, 25), (30, 31, 32, 33, 34), (39, 40, 41, 42, 43), (48, 49, 50, 51, 52), (57, 58, 59, 60, 61), (66, 67, 68, 69, 70), (75, 76, 77, 78, 79), (4, 5, 6, 7, 8), (13, 14, 15, 16, 17), (22, 23, 24, 25, 26), (31, 32, 33, 34, 35), (40, 41, 42, 43, 44), (49, 50, 51, 52, 53), (58, 59, 60, 61, 62), (67, 68, 69, 70, 71), (76, 77, 78, 79, 80), (0, 9, 18, 27, 36), (1, 10, 19, 28, 37), (2, 11, 20, 29, 38), (3, 12, 21, 30, 39), (4, 13, 22, 31, 40), (5, 14, 23, 32, 41), (6, 15, 24, 33, 42), (7, 16, 25, 34, 43), (8, 17, 26, 35, 44), (9, 18, 27, 36, 45), (10, 19, 28, 37, 46), (11, 20, 29, 38, 47), (12, 21, 30, 39, 48), (13, 22, 31, 40, 49), (14, 23, 32, 41, 50), (15, 24, 33, 42, 51), (16, 25, 34, 43, 52), (17, 26, 35, 44, 53), (18, 27, 36, 45, 54), (19, 28, 37, 46, 55), (20, 29, 38, 47, 56), (21, 30, 39, 48, 57), (22, 31, 40, 49, 58), (23, 32, 41, 50, 59), (24, 33, 42, 51, 60), (25, 34, 43, 52, 61), (26, 35, 44, 53, 62), (27, 36, 45, 54, 63), (28, 37, 46, 55, 64), (29, 38, 47, 56, 65), (30, 39, 48, 57, 66), (31, 40, 49, 58, 67), (32, 41, 50, 59, 68), (33, 42, 51, 60, 69), (34, 43, 52, 61, 70), (35, 44, 53, 62, 71), (36, 45, 54, 63, 72), (37, 46, 55, 64, 73), (38, 47, 56, 65, 74), (39, 48, 57, 66, 75), (40, 49, 58, 67, 76), (41, 50, 59, 68, 77), (42, 51, 60, 69, 78), (43, 52, 61, 70, 79), (44, 53, 62, 71, 80), (0, 10, 20, 30, 40), (1, 11, 21, 31, 41), (2, 12, 22, 32, 42), (3, 13, 23, 33, 43), (4, 14, 24, 34, 44), (9, 19, 29, 39, 49), (10, 20, 30, 40, 50), (11, 21, 31, 41, 51), (12, 22, 32, 42, 52), (13, 23, 33, 43, 53), (18, 28, 38, 48, 58), (19, 29, 39, 49, 59), (20, 30, 40, 50, 60), (21, 31, 41, 51, 61), (22, 32, 42, 52, 62), (27, 37, 47, 57, 67), (28, 38, 48, 58, 68), (29, 39, 49, 59, 69), (30, 40, 50, 60, 70), (31, 41, 51, 61, 71), (36, 46, 56, 66, 76), (37, 47, 57, 67, 77), (38, 48, 58, 68, 78), (39, 49, 59, 69, 79), (40, 50, 60, 70, 80), (4, 12, 20, 28, 36), (5, 13, 21, 29, 37), (6, 14, 22, 30, 38), (7, 15, 23, 31, 39), (8, 16, 24, 32, 40), (13, 21, 29, 37, 45), (14, 22, 30, 38, 46), (15, 23, 31, 39, 47), (16, 24, 32, 40, 48), (17, 25, 33, 41, 49), (22, 30, 38, 46, 54), (23, 31, 39, 47, 55), (24, 32, 40, 48, 56), (25, 33, 41, 49, 57), (26, 34, 42, 50, 58), (31, 39, 47, 55, 63), (32, 40, 48, 56, 64), (33, 41, 49, 57, 65), (34, 42, 50, 58, 66), (35, 43, 51, 59, 67), (40, 48, 56, 64, 72), (41, 49, 57, 65, 73), (42, 50, 58, 66, 74), (43, 51, 59, 67, 75), (44, 52, 60, 68, 76),(0, 1, 2, 3, 4), (9, 10, 11, 12, 13), (18, 19, 20, 21, 22), (27, 28, 29, 30, 31), (36, 37, 38, 39, 40), (45, 46, 47, 48, 49), (54, 55, 56, 57, 58), (63, 64, 65, 66, 67), (72, 73, 74, 75, 76), (1, 2, 3, 4, 5), (10, 11, 12, 13, 14), (19, 20, 21, 22, 23), (28, 29, 30, 31, 32), (37, 38, 39, 40, 41), (46, 47, 48, 49, 50), (55, 56, 57, 58, 59), (64, 65, 66, 67, 68), (73, 74, 75, 76, 77), (2, 3, 4, 5, 6), (11, 12, 13, 14, 15), (20, 21, 22, 23, 24), (29, 30, 31, 32, 33), (38, 39, 40, 41, 42), (47, 48, 49, 50, 51), (56, 57, 58, 59, 60), (65, 66, 67, 68, 69), (74, 75, 76, 77, 78), (3, 4, 5, 6, 7), (12, 13, 14, 15, 16), (21, 22, 23, 24, 25), (30, 31, 32, 33, 34), (39, 40, 41, 42, 43), (48, 49, 50, 51, 52), (57, 58, 59, 60, 61), (66, 67, 68, 69, 70), (75, 76, 77, 78, 79), (4, 5, 6, 7, 8), (13, 14, 15, 16, 17), (22, 23, 24, 25, 26), (31, 32, 33, 34, 35), (40, 41, 42, 43, 44), (49, 50, 51, 52, 53), (58, 59, 60, 61, 62), (67, 68, 69, 70, 71), (76, 77, 78, 79, 80), (0, 9, 18, 27, 36), (1, 10, 19, 28, 37), (2, 11, 20, 29, 38), (3, 12, 21, 30, 39), (4, 13, 22, 31, 40), (5, 14, 23, 32, 41), (6, 15, 24, 33, 42), (7, 16, 25, 34, 43), (8, 17, 26, 35, 44), (9, 18, 27, 36, 45), (10, 19, 28, 37, 46), (11, 20, 29, 38, 47), (12, 21, 30, 39, 48), (13, 22, 31, 40, 49), (14, 23, 32, 41, 50), (15, 24, 33, 42, 51), (16, 25, 34, 43, 52), (17, 26, 35, 44, 53), (18, 27, 36, 45, 54), (19, 28, 37, 46, 55), (20, 29, 38, 47, 56), (21, 30, 39, 48, 57), (22, 31, 40, 49, 58), (23, 32, 41, 50, 59), (24, 33, 42, 51, 60), (25, 34, 43, 52, 61), (26, 35, 44, 53, 62), (27, 36, 45, 54, 63), (28, 37, 46, 55, 64), (29, 38, 47, 56, 65), (30, 39, 48, 57, 66), (31, 40, 49, 58, 67), (32, 41, 50, 59, 68), (33, 42, 51, 60, 69), (34, 43, 52, 61, 70), (35, 44, 53, 62, 71), (36, 45, 54, 63, 72), (37, 46, 55, 64, 73), (38, 47, 56, 65, 74), (39, 48, 57, 66, 75), (40, 49, 58, 67, 76), (41, 50, 59, 68, 77), (42, 51, 60, 69, 78), (43, 52, 61, 70, 79), (44, 53, 62, 71, 80), (0, 10, 20, 30, 40), (1, 11, 21, 31, 41), (2, 12, 22, 32, 42), (3, 13, 23, 33, 43), (4, 14, 24, 34, 44), (9, 19, 29, 39, 49), (10, 20, 30, 40, 50), (11, 21, 31, 41, 51), (12, 22, 32, 42, 52), (13, 23, 33, 43, 53), (18, 28, 38, 48, 58), (19, 29, 39, 49, 59), (20, 30, 40, 50, 60), (21, 31, 41, 51, 61), (22, 32, 42, 52, 62), (27, 37, 47, 57, 67), (28, 38, 48, 58, 68), (29, 39, 49, 59, 69), (30, 40, 50, 60, 70), (31, 41, 51, 61, 71), (36, 46, 56, 66, 76), (37, 47, 57, 67, 77), (38, 48, 58, 68, 78), (39, 49, 59, 69, 79), (40, 50, 60, 70, 80), (4, 12, 20, 28, 36), (5, 13, 21, 29, 37), (6, 14, 22, 30, 38), (7, 15, 23, 31, 39), (8, 16, 24, 32, 40), (13, 21, 29, 37, 45), (14, 22, 30, 38, 46), (15, 23, 31, 39, 47), (16, 24, 32, 40, 48), (17, 25, 33, 41, 49), (22, 30, 38, 46, 54), (23, 31, 39, 47, 55), (24, 32, 40, 48, 56), (25, 33, 41, 49, 57), (26, 34, 42, 50, 58), (31, 39, 47, 55, 63), (32, 40, 48, 56, 64), (33, 41, 49, 57, 65), (34, 42, 50, 58, 66), (35, 43, 51, 59, 67), (40, 48, 56, 64, 72), (41, 49, 57, 65, 73), (42, 50, 58, 66, 74), (43, 51, 59, 67, 75), (44, 52, 60, 68, 76)]:
            if self.state[x] == self.state[y] == self.state[z] == self.state[p] == self.state[q]:
                if self.state[x] == 1:
                    return 1
                elif self.state[x] == 2:
                    return 2

        if [i for i in range(81) if self.state[i] == 0] == []:
            return -1
        return 0

    def __repr__(self):
        cells = []
        for i in range(81):
            cells.append(NAMES[self.state[i]].center(6))
        return BOARD_FORMAT.format(*cells)


class Node:
    def __init__(self, move=None, parent=None, state=None):
        self.move = move
        self.parentNode = parent
        self.childNodes = []
        self.wins = 0
        self.visits = 0
        self.untriedMoves = state.GetMoves()
        self.playerJustMoved = state.playerJustMoved

    def UCTSelectChild(self):
        s = sorted(self.childNodes, key=lambda c: c.wins / c.visits + sqrt(2 * log(self.visits) / c.visits))
        return s[-1]

    def AddChild(self, m, s):
        n = Node(move=m, parent=self, state=copy.deepcopy(s))
        self.untriedMoves.remove(m)
        self.childNodes.append(n)
        return n

    def Update(self, result):
        self.visits += 1
        self.wins += result

    def __repr__(self):
        return "[M" + str(self.move) + " W/V " + str(self.wins) + "/" + str(self.visits) + " U" + str(
            self.untriedMoves) + "]"

    def ChildrenToString(self):
        s = ""
        for c in self.childNodes:
            s += str(c) + "\n"
        return s


def UCT(rootstate, itermax):
    rootnode = Node(state=rootstate)
    sTime = time.time()
    for i in range(itermax):
        node = rootnode
        state = copy.deepcopy(rootstate)

        # selection
        while node.untriedMoves == [] and node.childNodes != []:
            node = node.UCTSelectChild()
            state.DoMove(node.move)

        # Expansion
        if node.untriedMoves != []:
            m = random.choice(node.untriedMoves)
            state.DoMove(m)
            node = node.AddChild(m, state)

        # simulation
        while state.GetMoves() != []:
            state.DoMove(random.choice(state.GetMoves()))

        # BackPropagation
        while node != None:
            node.Update(state.GetResult(node.playerJustMoved))
            node = node.parentNode

    print(rootnode.ChildrenToString())
    eTime = time.time()
    print('AI가 수를 계산하는데 걸린 시간 : ', eTime - sTime)
    s = sorted(rootnode.childNodes, key=lambda c: c.wins / c.visits)
    return sorted(s, key=lambda c: c.visits)[-1].move


def UCTPlayGame():
    state = TicTacToe()
    while state.GetMoves() != []:
        print(str(state))
        if state.playerJustMoved == 1:
            rootstate = copy.deepcopy(state)
            m = UCT(rootstate, itermax=10000)

        else:
            m1 = input("수를 둘 행(1-9)을 입력하세요 : ")
            m2 = input("수를 둘 열(1-9)을 입력하세요 : ")
            m=m1+m2
            m = int(m)
            m = m-10-int(m1)
        state.DoMove(m)

    if state.GetResult(state.playerJustMoved) == 1.0:
        print("Player " + str(state.playerJustMoved) + " Wins!!")

    elif state.GetResult(state.playerJustMoved) == 0.0:
        print("Player " + str(3 - state.playerJustMoved) + " Wins!!")

    else:
        print("Draw!!")


if __name__ == "__main__":
    UCTPlayGame()
